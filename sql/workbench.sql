-- MySQL Script generated by MySQL Workbench
-- Fri Nov  7 12:22:04 2025
-- Model: New Model    Version: 1.0
-- MySQL Workbench Forward Engineering

SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0;
SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0;
SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION';

-- -----------------------------------------------------
-- Schema fiat_depreciacion_dw
-- -----------------------------------------------------
DROP SCHEMA IF EXISTS `fiat_depreciacion_dw` ;

-- -----------------------------------------------------
-- Schema fiat_depreciacion_dw
-- -----------------------------------------------------
CREATE SCHEMA IF NOT EXISTS `fiat_depreciacion_dw` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci ;
SHOW WARNINGS;
USE `fiat_depreciacion_dw` ;

-- -----------------------------------------------------
-- Table `dim_fuente`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `dim_fuente` ;

SHOW WARNINGS;
CREATE TABLE IF NOT EXISTS `dim_fuente` (
  `fuente_key` INT NOT NULL AUTO_INCREMENT,
  `codigo` VARCHAR(20) NOT NULL,
  `institucion` VARCHAR(150) NOT NULL,
  `url_base` VARCHAR(500) NULL DEFAULT NULL,
  `licencia` VARCHAR(50) NULL DEFAULT NULL,
  `pais_origen` VARCHAR(3) NULL DEFAULT NULL,
  `frecuencia_actualizacion` INT NULL DEFAULT NULL,
  `contacto_responsable` VARCHAR(100) NULL DEFAULT NULL,
  `fecha_ultima_actualizacion` DATE NULL DEFAULT NULL,
  `confiabilidad` VARCHAR(10) NULL DEFAULT NULL,
  PRIMARY KEY (`fuente_key`))
ENGINE = InnoDB
AUTO_INCREMENT = 11
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci
COMMENT = 'DimensiÃ³n de fuentes de datos';

SHOW WARNINGS;
CREATE UNIQUE INDEX `codigo` ON `dim_fuente` (`codigo` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_fuente_codigo` ON `dim_fuente` (`codigo` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_fuente_institucion` ON `dim_fuente` (`institucion` ASC) VISIBLE;

SHOW WARNINGS;

-- -----------------------------------------------------
-- Table `dim_geografia`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `dim_geografia` ;

SHOW WARNINGS;
CREATE TABLE IF NOT EXISTS `dim_geografia` (
  `geo_key` INT NOT NULL AUTO_INCREMENT,
  `codigo` VARCHAR(10) NOT NULL,
  `nombre` VARCHAR(100) NOT NULL,
  `codigo_iso` VARCHAR(5) NULL DEFAULT NULL,
  `tipo` VARCHAR(20) NOT NULL,
  `geo_padre_key` INT NULL DEFAULT NULL,
  `nivel_jerarquia` TINYINT NULL DEFAULT NULL,
  `poblacion` BIGINT NULL DEFAULT NULL,
  PRIMARY KEY (`geo_key`),
  CONSTRAINT `dim_geografia_ibfk_1`
    FOREIGN KEY (`geo_padre_key`)
    REFERENCES `dim_geografia` (`geo_key`))
ENGINE = InnoDB
AUTO_INCREMENT = 42
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci
COMMENT = 'DimensiÃ³n geogrÃ¡fica jerÃ¡rquica';

SHOW WARNINGS;
CREATE UNIQUE INDEX `codigo` ON `dim_geografia` (`codigo` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_geografia_codigo` ON `dim_geografia` (`codigo` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_geografia_nombre` ON `dim_geografia` (`nombre` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_geografia_tipo` ON `dim_geografia` (`tipo` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_geografia_padre` ON `dim_geografia` (`geo_padre_key` ASC) VISIBLE;

SHOW WARNINGS;

-- -----------------------------------------------------
-- Table `dim_indicador`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `dim_indicador` ;

SHOW WARNINGS;
CREATE TABLE IF NOT EXISTS `dim_indicador` (
  `indicador_key` INT NOT NULL AUTO_INCREMENT,
  `codigo` VARCHAR(50) NOT NULL,
  `nombre` VARCHAR(100) NOT NULL,
  `descripcion` TEXT NULL DEFAULT NULL,
  `formula_calculo` VARCHAR(500) NULL DEFAULT NULL,
  `categoria` VARCHAR(50) NOT NULL,
  `subcategoria` VARCHAR(100) NULL DEFAULT NULL,
  `es_agregable` TINYINT(1) NULL DEFAULT '1',
  `unidad_base` VARCHAR(20) NOT NULL,
  `periodo_base` VARCHAR(20) NULL DEFAULT NULL,
  `frecuencia_actualizacion` VARCHAR(20) NULL DEFAULT NULL,
  PRIMARY KEY (`indicador_key`))
ENGINE = InnoDB
AUTO_INCREMENT = 18
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci
COMMENT = 'DimensiÃ³n de indicadores macroeconÃ³micos';

SHOW WARNINGS;
CREATE UNIQUE INDEX `codigo` ON `dim_indicador` (`codigo` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_indicador_codigo` ON `dim_indicador` (`codigo` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_indicador_categoria` ON `dim_indicador` (`categoria` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_indicador_nombre` ON `dim_indicador` (`nombre` ASC) VISIBLE;

SHOW WARNINGS;

-- -----------------------------------------------------
-- Table `dim_tiempo`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `dim_tiempo` ;

SHOW WARNINGS;
CREATE TABLE IF NOT EXISTS `dim_tiempo` (
  `tiempo_key` INT NOT NULL AUTO_INCREMENT,
  `fecha` DATE NOT NULL,
  `anio` SMALLINT NOT NULL,
  `mes` TINYINT NOT NULL,
  `trimestre` TINYINT NOT NULL,
  `semana` TINYINT NOT NULL,
  `dia_semana` TINYINT NOT NULL,
  `nombre_mes` VARCHAR(20) NOT NULL,
  `nombre_dia` VARCHAR(20) NOT NULL,
  `es_festivo` TINYINT(1) NULL DEFAULT '0',
  `periodo_fiscal` VARCHAR(10) NULL DEFAULT NULL,
  `anio_mes` VARCHAR(7) NOT NULL,
  `anio_trimestre` VARCHAR(7) NOT NULL,
  PRIMARY KEY (`tiempo_key`))
ENGINE = InnoDB
AUTO_INCREMENT = 5845
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci
COMMENT = 'DimensiÃ³n temporal con granularidad diaria (2010-2025)';

SHOW WARNINGS;
CREATE UNIQUE INDEX `fecha` ON `dim_tiempo` (`fecha` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_tiempo_fecha` ON `dim_tiempo` (`fecha` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_tiempo_anio_mes` ON `dim_tiempo` (`anio` ASC, `mes` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_tiempo_anio_trimestre` ON `dim_tiempo` (`anio` ASC, `trimestre` ASC) VISIBLE;

SHOW WARNINGS;

-- -----------------------------------------------------
-- Table `dim_unidad`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `dim_unidad` ;

SHOW WARNINGS;
CREATE TABLE IF NOT EXISTS `dim_unidad` (
  `unit_key` INT NOT NULL AUTO_INCREMENT,
  `simbolo` VARCHAR(20) NOT NULL,
  `descripcion` VARCHAR(100) NULL DEFAULT NULL,
  `tipo_medida` VARCHAR(20) NOT NULL,
  `decimales` TINYINT NULL DEFAULT '2',
  `factor_conversion` DECIMAL(15,6) NULL DEFAULT '1.000000',
  PRIMARY KEY (`unit_key`))
ENGINE = InnoDB
AUTO_INCREMENT = 13
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci
COMMENT = 'DimensiÃ³n de unidades de medida';

SHOW WARNINGS;
CREATE UNIQUE INDEX `simbolo` ON `dim_unidad` (`simbolo` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_unidad_simbolo` ON `dim_unidad` (`simbolo` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_unidad_tipo` ON `dim_unidad` (`tipo_medida` ASC) VISIBLE;

SHOW WARNINGS;

-- -----------------------------------------------------
-- Table `etl_logs`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `etl_logs` ;

SHOW WARNINGS;
CREATE TABLE IF NOT EXISTS `etl_logs` (
  `log_id` INT NOT NULL AUTO_INCREMENT,
  `proceso` VARCHAR(100) NOT NULL,
  `inicio` TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,
  `fin` TIMESTAMP NULL DEFAULT NULL,
  `estado` VARCHAR(20) NULL DEFAULT NULL,
  `registros_procesados` INT NULL DEFAULT '0',
  `registros_insertados` INT NULL DEFAULT '0',
  `registros_actualizados` INT NULL DEFAULT '0',
  `registros_rechazados` INT NULL DEFAULT '0',
  `mensaje_error` TEXT NULL DEFAULT NULL,
  `archivo_origen` VARCHAR(500) NULL DEFAULT NULL,
  `usuario_ejecucion` VARCHAR(50) NULL DEFAULT (user()),
  PRIMARY KEY (`log_id`))
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci
COMMENT = 'Registro de ejecuciones ETL';

SHOW WARNINGS;
CREATE INDEX `idx_etl_fecha` ON `etl_logs` (`inicio` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_etl_estado` ON `etl_logs` (`estado` ASC) VISIBLE;

SHOW WARNINGS;

-- -----------------------------------------------------
-- Table `hechos_indicadores_temporales`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `hechos_indicadores_temporales` ;

SHOW WARNINGS;
CREATE TABLE IF NOT EXISTS `hechos_indicadores_temporales` (
  `tiempo_key` INT NOT NULL,
  `indicador_key` INT NOT NULL,
  `geo_key` INT NOT NULL,
  `unit_key` INT NOT NULL,
  `fuente_key` INT NOT NULL,
  `valor` DECIMAL(15,4) NOT NULL,
  `valor_anterior` DECIMAL(15,4) NULL DEFAULT NULL,
  `variacion_absoluta` DECIMAL(15,4) NULL DEFAULT NULL,
  `variacion_pct` DECIMAL(8,4) NULL DEFAULT NULL,
  `calidad_dato` VARCHAR(20) NULL DEFAULT 'real',
  `probabilidad_imputacion` DECIMAL(5,4) NULL DEFAULT NULL,
  `metodo_imputacion` VARCHAR(100) NULL DEFAULT NULL,
  `ts_actualizacion` TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `ts_carga` TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,
  `usuario_carga` VARCHAR(50) NULL DEFAULT (user()),
  PRIMARY KEY (`tiempo_key`, `indicador_key`, `geo_key`, `unit_key`, `fuente_key`),
  CONSTRAINT `fk_fuente`
    FOREIGN KEY (`fuente_key`)
    REFERENCES `dim_fuente` (`fuente_key`)
    ON DELETE RESTRICT,
  CONSTRAINT `fk_geografia`
    FOREIGN KEY (`geo_key`)
    REFERENCES `dim_geografia` (`geo_key`)
    ON DELETE RESTRICT,
  CONSTRAINT `fk_indicador`
    FOREIGN KEY (`indicador_key`)
    REFERENCES `dim_indicador` (`indicador_key`)
    ON DELETE RESTRICT,
  CONSTRAINT `fk_tiempo`
    FOREIGN KEY (`tiempo_key`)
    REFERENCES `dim_tiempo` (`tiempo_key`)
    ON DELETE RESTRICT,
  CONSTRAINT `fk_unidad`
    FOREIGN KEY (`unit_key`)
    REFERENCES `dim_unidad` (`unit_key`)
    ON DELETE RESTRICT)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci
COMMENT = 'Tabla de hechos central del DW';

SHOW WARNINGS;
CREATE INDEX `fk_unidad` ON `hechos_indicadores_temporales` (`unit_key` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_hechos_tiempo` ON `hechos_indicadores_temporales` (`tiempo_key` DESC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_hechos_tiempo_indicador` ON `hechos_indicadores_temporales` (`tiempo_key` DESC, `indicador_key` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_hechos_indicador` ON `hechos_indicadores_temporales` (`indicador_key` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_hechos_geografia` ON `hechos_indicadores_temporales` (`geo_key` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_hechos_fuente` ON `hechos_indicadores_temporales` (`fuente_key` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_hechos_geo_tiempo` ON `hechos_indicadores_temporales` (`geo_key` ASC, `tiempo_key` DESC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_hechos_calidad` ON `hechos_indicadores_temporales` (`calidad_dato` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_hechos_valor_rango` ON `hechos_indicadores_temporales` (`valor` ASC) VISIBLE;

SHOW WARNINGS;

-- -----------------------------------------------------
-- Table `metadata_dw`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `metadata_dw` ;

SHOW WARNINGS;
CREATE TABLE IF NOT EXISTS `metadata_dw` (
  `clave` VARCHAR(100) NOT NULL,
  `valor` TEXT NOT NULL,
  `tipo_dato` VARCHAR(20) NULL DEFAULT NULL,
  `descripcion` VARCHAR(500) NULL DEFAULT NULL,
  `fecha_actualizacion` TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`clave`))
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci
COMMENT = 'Metadatos del Data Warehouse';

SHOW WARNINGS;
CREATE INDEX `idx_metadata_tipo` ON `metadata_dw` (`tipo_dato` ASC) VISIBLE;

SHOW WARNINGS;

-- -----------------------------------------------------
-- Table `validacion_calidad`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `validacion_calidad` ;

SHOW WARNINGS;
CREATE TABLE IF NOT EXISTS `validacion_calidad` (
  `validacion_id` INT NOT NULL AUTO_INCREMENT,
  `timestamp_validacion` TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,
  `tabla_validada` VARCHAR(100) NOT NULL,
  `regla_validacion` VARCHAR(200) NOT NULL,
  `tipo_validacion` VARCHAR(50) NULL DEFAULT NULL,
  `resultado` VARCHAR(20) NULL DEFAULT NULL,
  `registros_afectados` INT NULL DEFAULT NULL,
  `porcentaje_error` DECIMAL(5,2) NULL DEFAULT NULL,
  `descripcion_detalle` TEXT NULL DEFAULT NULL,
  `accion_correctiva` TEXT NULL DEFAULT NULL,
  PRIMARY KEY (`validacion_id`))
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci
COMMENT = 'Validaciones de calidad de datos';

SHOW WARNINGS;
CREATE INDEX `idx_validacion_fecha` ON `validacion_calidad` (`timestamp_validacion` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_validacion_tabla` ON `validacion_calidad` (`tabla_validada` ASC) VISIBLE;

SHOW WARNINGS;
CREATE INDEX `idx_validacion_resultado` ON `validacion_calidad` (`resultado` ASC) VISIBLE;

SHOW WARNINGS;
USE `fiat_depreciacion_dw` ;

-- -----------------------------------------------------
-- procedure poblar_dim_tiempo
-- -----------------------------------------------------

USE `fiat_depreciacion_dw`;
DROP procedure IF EXISTS `poblar_dim_tiempo`;
SHOW WARNINGS;

DELIMITER $$
USE `fiat_depreciacion_dw`$$
CREATE DEFINER=`root`@`localhost` PROCEDURE `poblar_dim_tiempo`()
BEGIN
    DECLARE fecha_actual DATE DEFAULT '2010-01-01';
    DECLARE fecha_fin DATE DEFAULT '2025-12-31';
    
    WHILE fecha_actual <= fecha_fin DO
        INSERT INTO dim_tiempo (
            fecha, anio, mes, trimestre, semana, dia_semana,
            nombre_mes, nombre_dia, es_festivo, periodo_fiscal,
            anio_mes, anio_trimestre
        ) VALUES (
            fecha_actual,
            YEAR(fecha_actual),
            MONTH(fecha_actual),
            QUARTER(fecha_actual),
            WEEK(fecha_actual, 3),
            DAYOFWEEK(fecha_actual),
            CASE MONTH(fecha_actual)
                WHEN 1 THEN 'Enero' WHEN 2 THEN 'Febrero' WHEN 3 THEN 'Marzo'
                WHEN 4 THEN 'Abril' WHEN 5 THEN 'Mayo' WHEN 6 THEN 'Junio'
                WHEN 7 THEN 'Julio' WHEN 8 THEN 'Agosto' WHEN 9 THEN 'Septiembre'
                WHEN 10 THEN 'Octubre' WHEN 11 THEN 'Noviembre' WHEN 12 THEN 'Diciembre'
            END,
            CASE DAYOFWEEK(fecha_actual)
                WHEN 1 THEN 'Domingo' WHEN 2 THEN 'Lunes' WHEN 3 THEN 'Martes'
                WHEN 4 THEN 'MiÃ©rcoles' WHEN 5 THEN 'Jueves' 
                WHEN 6 THEN 'Viernes' WHEN 7 THEN 'SÃ¡bado'
            END,
            FALSE,
            CONCAT('Q', QUARTER(fecha_actual)),
            DATE_FORMAT(fecha_actual, '%Y-%m'),
            CONCAT(YEAR(fecha_actual), '-Q', QUARTER(fecha_actual))
        );
        
        SET fecha_actual = DATE_ADD(fecha_actual, INTERVAL 1 DAY);
    END WHILE;
END$$

DELIMITER ;
SHOW WARNINGS;

SET SQL_MODE=@OLD_SQL_MODE;
SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;
